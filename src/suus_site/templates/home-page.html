{% extends 'base.html' %}

{% block css %}
{% load static %}
    <link rel="stylesheet" type="text/css" href="{% static 'css/home-page.css' %}">
{% endblock css %}


{% block content %}
    <div class="snow-container"></div>
    <div class="poem-container"></div>

    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const snowContainer = document.querySelector(".snow-container");
            const poemContainer = document.querySelector(".poem-container");
        
            const particlesPerThousandPixels = 0.1;
            const fallSpeed = 0.75;
            const maxSnowflakes = 200;
            const snowflakes = [];
            const clickedIcons = new Set();
        
            const poemLines = [
                "Aller liefste Suus,",
                "De papieren gedichten zullen al snel vergaan,",
                "maar dit technisch ingestoken poetisch epos, blijft langer bestaan.",
                "Een vleugje attentie van jou is hierbij onontbeerlijk,",
                "geen zorgen, dit kan met een glas wijn vanuit je luie stoel, heerlijk.",
                "Zie hoe op het scherm, iconen neerdwarrelen als in een winters tafereel,",
                "Klik op de iconen en genereer het gedicht manueel.",
            ];

            let icons = [
                {
                    path: "{% static 'images/renesse.png' %}",
                    description: "Suus gaat graag naar Renesse, een weekend, een week of zelfs meer. Met Ger en Guus als buren is dat altijd een feestje & gezellig. Op het strand wandelen met Loes, zonnen bij de kotjes of fietsen zijn o.a. activiteiten die ze graag doen. Daarnaast gaan ze ook graag een lekker hapje eten bij de nodige leuke restaurantjes in Renesse en omgeving."
                },
            ];
        
            let currentLine = 0;
        
            function revealNextLine() {
                if (currentLine < poemLines.length) {
                    const lineElement = document.createElement("div");
                    lineElement.textContent = poemLines[currentLine];
                    lineElement.classList.add("falling-line");
                    poemContainer.appendChild(lineElement);
        
                    lineElement.style.left = `${Math.random() * 80}vw`;
                    currentLine++;
                }
            }
        
            let poemInterval = setInterval(() => {
                if (currentLine < poemLines.length) {
                    requestAnimationFrame(revealNextLine);
                } else {
                    clearInterval(poemInterval);
                    setTimeout(displayIcons, 3000);
                }
            }, 3000);
        
            function displayIcons() {
                const shuffledIcons = icons.sort(() => Math.random() - 0.5);
            
                shuffledIcons.forEach((icon, index) => {
                    const iconElement = document.createElement("img");
                    iconElement.src = icon.path;
                    iconElement.classList.add("falling-icon");
                    iconElement.style.left = `${Math.random() * 80}vw`;
            
                    iconElement.addEventListener("click", async () => {
                        if (clickedIcons.has(icon)) {
                            return;
                        }

                        iconElement.style.animation += ", fadeOut 1s linear forwards";

                        clickedIcons.add(icon);
                    
                        icons = icons.filter((item) => item !== icon);
                    
                        iconElement.style.pointerEvents = "none";

                        try {
                            // Make the API request
                            const response = await fetch("get-llm-response-for-suus/", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": getCsrfToken(),
                                },
                                body: JSON.stringify({
                                    prompt: icon.description,
                                }),
                            });
                    
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                    
                            const responseData = await response.json();
                            console.log("RESPONSE DATA: ", responseData);
                    
                            const poemLines = responseData.poem_lines;
                    
                            if (poemLines) {
                                console.log("Poem Lines:", poemLines.join("\n")); 
                                // Display them if you wish
                                const poemElement = document.createElement("div");
                                poemElement.classList.add("poem");
                                poemElement.textContent = poemLines.join("\n");
                                document.body.appendChild(poemElement);
                            } else {
                                console.error("No poem lines found in the response!");
                            }
                    
                        } catch (error) {
                            console.error("Error fetching the poem:", error);
                        }
                    });
            
                    document.body.appendChild(iconElement);
                    iconElement.style.animation = "text-fall 10s linear forwards";
            
                    // Repeat displaying logic if not clicked, etc.
                    setTimeout(() => {
                        if (icons.includes(icon) && !document.hidden) {
                            displaySingleIcon(icon);
                        }
                    }, 10000);
                });
            }
            
        
            function displaySingleIcon(iconObj) {
                const { path, description } = iconObj;

                const iconElement = document.createElement("img");
                iconElement.src = path;
                iconElement.classList.add("falling-icon");
                iconElement.style.left = `${Math.random() * 80}vw`;
            
                iconElement.addEventListener("click", async () => {
                    // If already clicked, bail out
                    if (clickedIcons.has(iconObj)) {
                        return;
                    }

                    iconElement.style.animation += ", fadeOut 1s linear forwards";

                    // Mark icon as clicked
                    clickedIcons.add(iconObj);
                
                    icons = icons.filter((item) => item !== iconObj);
                
                    iconElement.style.pointerEvents = "none";

                    try {
                        // Make the API request with the description as part of the prompt
                        const response = await fetch("/get-llm-response-for-suus/", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": getCsrfToken(),
                            },
                            body: JSON.stringify({
                                prompt: description,
                            }),
                        });
            
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
            
                        const responseData = await response.json();
            
                        const poemLines = responseData.poem_lines;
            
                        if (poemLines) {
                            console.log("Poem Lines:", poemLines.join("\n"));
                            const poemElement = document.createElement("div");
                            poemElement.classList.add("poem");
                            poemElement.textContent = poemLines.join("\n");
                            document.body.appendChild(poemElement);
                        } else {
                            console.error("No poem lines found in the response!");
                        }
            
                        iconElement.addEventListener("animationend", () => {
                            iconElement.remove();
                        });
            
                        clickedIcons.add(path);
                    } catch (error) {
                        console.error("Error fetching the poem:", error);
                    }
                });
            
                document.body.appendChild(iconElement);
                iconElement.style.animation = "text-fall 10s linear forwards";
            
                setTimeout(() => {
                    if (!clickedIcons.has(path) && !document.hidden) {
                        displaySingleIcon(iconObj);
                    }
                }, 10000);
            }
            
        
            let snowflakeInterval;
            let isTabActive = true;
        
            function resetSnowflake(snowflake) {
                const size = Math.random() * 5 + 1;
                const viewportWidth = window.innerWidth - size;
                const viewportHeight = window.innerHeight;
        
                snowflake.style.width = `${size}px`;
                snowflake.style.height = `${size}px`;
                snowflake.style.left = `${Math.random() * viewportWidth}px`;
                snowflake.style.top = `-${size}px`;
        
                const animationDuration = (Math.random() * 3 + 2) / fallSpeed;
                snowflake.style.animationDuration = `${animationDuration}s`;
                snowflake.style.animationTimingFunction = "linear";
                snowflake.style.animationName =
                    Math.random() < 0.5 ? "fall" : "diagonal-fall";
        
                setTimeout(() => {
                    if (parseInt(snowflake.style.top, 10) < viewportHeight) {
                        resetSnowflake(snowflake);
                    } else {
                        snowflake.remove();
                    }
                }, animationDuration * 1000);
            }
        
            function createSnowflake() {
                if (snowflakes.length < maxSnowflakes) {
                    const snowflake = document.createElement("div");
                    snowflake.classList.add("snowflake");
                    snowflakes.push(snowflake);
                    snowContainer.appendChild(snowflake);
                    resetSnowflake(snowflake);
                }
            }
        
            function generateSnowflakes() {
                const numberOfParticles =
                    Math.ceil((window.innerWidth * window.innerHeight) / 1000) *
                    particlesPerThousandPixels;
                const interval = 5000 / numberOfParticles;
        
                clearInterval(snowflakeInterval);
                snowflakeInterval = setInterval(() => {
                    if (isTabActive && snowflakes.length < maxSnowflakes) {
                        requestAnimationFrame(createSnowflake);
                    }
                }, interval);
            }
        
            generateSnowflakes();
        
            window.addEventListener("resize", () => {
                clearInterval(snowflakeInterval);
                setTimeout(generateSnowflakes, 1000);
            });
        });

        function getCsrfToken() {
            const csrfToken = document.cookie
                .split(";")
                .map(cookie => cookie.trim())
                .find(cookie => cookie.startsWith("csrftoken="));
            return csrfToken ? csrfToken.split("=")[1] : null;
        }
      </script>
{% endblock content %}
